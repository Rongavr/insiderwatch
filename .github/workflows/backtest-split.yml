name: Backtest (Quarter-Split)

on:
  workflow_dispatch: {}

jobs:
  backfill:
    name: Backfill ${{ matrix.label }}
    runs-on: ubuntu-latest
    timeout-minutes: 360
    strategy:
      fail-fast: false
      matrix:
        include:
          # 2024
          - { label: "2024Q1", start: "2024-01-01", end: "2024-03-31" }
          - { label: "2024Q2", start: "2024-04-01", end: "2024-06-30" }
          - { label: "2024Q3", start: "2024-07-01", end: "2024-09-30" }
          - { label: "2024Q4", start: "2024-10-01", end: "2024-12-31" }
          # 2025
          - { label: "2025Q1", start: "2025-01-01", end: "2025-03-31" }
          - { label: "2025Q2", start: "2025-04-01", end: "2025-06-30" }
          - { label: "2025Q3", start: "2025-07-01", end: "2025-09-30" }
          # Q4 uses "today" → leave end blank so script defaults to now (UTC)
          - { label: "2025Q4", start: "2025-10-01", end: "" }

    env:
      SEC_EMAIL: "rongavr@gmail.com"

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas beautifulsoup4 lxml python-dateutil pyarrow tqdm

      - name: Backfill ${{ matrix.label }}
        run: |
          END_ARG=""
          if [ -n "${{ matrix.end }}" ]; then END_ARG="--end ${{ matrix.end }}"; fi
          python backtest/backfill_sec.py \
            --start ${{ matrix.start }} $END_ARG \
            --out trades_${{ matrix.label }}.parquet

      - name: Upload artifact ${{ matrix.label }}
        uses: actions/upload-artifact@v4
        with:
          name: trades_${{ matrix.label }}
          path: trades_${{ matrix.label }}.parquet
          if-no-files-found: error

  merge_build_eval:
    name: Merge → Build Signals → Evaluate
    needs: backfill
    runs-on: ubuntu-latest
    env:
      SEC_EMAIL: "rongavr@gmail.com"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pandas pyarrow

      - name: Download all trades_* artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: trades_*
          merge-multiple: true
          path: ./trades_parts

      - name: Merge parquet parts → trades.parquet
        run: |
          python - <<'PY'
          import glob, pandas as pd
          parts = sorted(glob.glob("trades_parts/trades_*.parquet"))
          if not parts:
              raise SystemExit("No trades_* artifacts found")
          dfs = [pd.read_parquet(p) for p in parts]
          df = pd.concat(dfs, ignore_index=True)

          # de-dupe conservatively
          cols = [c for c in ["symbol","owner","txn_date","amount_usd","xml_url","filing_url","shares","price"] if c in df.columns]
          df = df.drop_duplicates(subset=cols)

          df.to_parquet("trades.parquet")
          print("Merged", len(parts), "parts →", len(df), "rows")
          PY

      - name: Build signals
        run: |
          pip install requests beautifulsoup4 lxml python-dateutil tqdm
          python backtest/build_signals.py \
            --trades trades.parquet \
            --out signals.parquet \
            --window 14 --min_owners 3 --min_usd 300000

      - name: Evaluate
        run: |
          python backtest/evaluate.py \
            --signals signals.parquet \
            --out report.csv \
            --cost_bps 20 \
            --horizons 5 21 63

      - name: Upload outputs
        uses: actions/upload-artifact@v4
        with:
          name: backtest_outputs
          path: |
            trades.parquet
            signals.parquet
            report.csv
