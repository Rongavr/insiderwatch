name: TASE Sell Alerts (2x daily)
run-name: "TASE (2x daily) — ${{ github.event_name }}"

on:
  workflow_dispatch:
  schedule:
    # GitHub cron is UTC; IL ≈ 09:45 / 17:35 → 07:45 / 15:35 UTC
    - cron: '45 7 * * *'
    - cron: '35 15 * * *'

permissions:
  contents: write   # needed to commit updated .tase_state.txt

concurrency:
  group: tase-sells
  cancel-in-progress: true

jobs:
  tase:
    runs-on: ubuntu-latest
    timeout-minutes: 12

    env:
      FROM_EMAIL:    ${{ secrets.FROM_EMAIL }}
      MAIL_USERNAME: ${{ secrets.MAIL_USERNAME }}
      MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
      SMTP_SERVER:   ${{ secrets.SMTP_SERVER }}
      SMTP_PORT:     ${{ secrets.SMTP_PORT }}
      TO_EMAIL:      ${{ secrets.TO_EMAIL }}

      # --- Normal mode (auto-scan). Keep empty unless you want to force specific pages. ---
      TASE_LINKS: ""

      # Scan window (tuned to finish < ~10m). The script updates .tase_state.txt as it advances.
      TASE_LAST_ID:    "1702700"  # one-time seed; real start comes from .tase_state.txt if present
      TASE_SCAN_AHEAD: "600"      # probe up to 600 IDs per run
      TASE_SLEEP:      "0.60"     # politeness delay (seconds)

      # Optional: minimum total NIS to alert (0 = show all)
      MIN_NIS:         "0"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 lxml pandas python-dateutil pdfminer.six

      - name: Run TASE scanner
        run: python scripts/tase_scan.py

      - name: Ensure outputs exist (don’t fail on “no results”)
        run: |
          test -f tase_trades.csv || echo "company,tase_code,owner,action,qty,price,amount_nis,when,source" > tase_trades.csv
          test -f tase_alerts.csv || echo "company,tase_code,trades,est_total_nis,when" > tase_alerts.csv
          test -f .tase_state.txt || echo "${{ env.TASE_LAST_ID }}" > .tase_state.txt

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tase_outputs
          path: |
            tase_trades.csv
            tase_alerts.csv
            .tase_state.txt
          if-no-files-found: warn

      - name: Commit updated scan state
        continue-on-error: true
        if: always()
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(tase): update .tase_state.txt [skip ci]"
          file_pattern: .tase_state.txt
          commit_user_name: github-actions[bot]
          commit_user_email: 41898282+github-actions[bot]@users.noreply.github.com
