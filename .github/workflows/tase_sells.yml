name: TASE Sell Alerts (2x daily)
run-name: "TASE (2x daily) — ${{ github.event_name }}"

on:
  workflow_dispatch:
  schedule:
    - cron: '45 7 * * *'   # 09:45 IL
    - cron: '35 15 * * *'  # 17:35 IL

permissions: { contents: write }
concurrency:
  group: tase-sells
  cancel-in-progress: true

jobs:
  tase:
    runs-on: ubuntu-latest
    timeout-minutes: 20   # ⬅️ give the scanner headroom

    env:
      FROM_EMAIL:    ${{ secrets.FROM_EMAIL }}
      MAIL_USERNAME: ${{ secrets.MAIL_USERNAME }}
      MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
      SMTP_SERVER:   ${{ secrets.SMTP_SERVER }}
      SMTP_PORT:     ${{ secrets.SMTP_PORT }}
      TO_EMAIL:      ${{ secrets.TO_EMAIL }}

      TASE_LINKS: ""          # auto-scan
      TASE_LAST_ID: "1702700" # seed; script updates .tase_state.txt
      TASE_SCAN_AHEAD: "150"  # ⬅️ smaller window to finish on time
      TASE_SLEEP: "0.40"      # polite + quicker than 0.5
      MIN_NIS: "0"

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.12', cache: 'pip' }

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 lxml pandas python-dateutil pdfminer.six

      - name: Run TASE scanner
        run: python scripts/tase_scan.py

      - name: Ensure outputs exist
        run: |
          test -f tase_trades.csv || echo "company,tase_code,owner,action,qty,price,amount_nis,when,source" > tase_trades.csv
          test -f tase_alerts.csv || echo "company,tase_code,trades,est_total_nis,when" > tase_alerts.csv
          test -f .tase_state.txt || echo "${{ env.TASE_LAST_ID }}" > .tase_state.txt

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tase_outputs
          path: |
            tase_trades.csv
            tase_alerts.csv
            .tase_state.txt
          if-no-files-found: warn

      - name: Commit updated scan state
        continue-on-error: true
        if: always()
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(tase): update .tase_state.txt [skip ci]"
          file_pattern: .tase_state.txt
          commit_user_name: github-actions[bot]
          commit_user_email: 41898282+github-actions[bot]@users.noreply.github.com
